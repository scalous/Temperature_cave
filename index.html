<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Évolution de la Température</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>
<body>
    <h2>Évolution de la Température</h2>
    <label for="start-date">Date de début :</label>
    <input type="date" id="start-date">
    <label for="end-date">Date de fin :</label>
    <input type="date" id="end-date">
    <button onclick="fetchData()">Afficher</button>
    <canvas id="tempChart"></canvas>

    <script>
        let tempChart;

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toISOString().slice(0, 19).replace("T", " ");
        }

        async function fetchData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            const formattedStartDate = formatDate(startDate);
            const formattedEndDate = formatDate(endDate);
            
            const apiKey = "2851323"; // Remplace par ta vraie clé
            
            const garageUrl = `https://api.thingspeak.com/channels/2851323/fields/1.json?api_key=${apiKey}&start=${formattedStartDate}&end=${formattedEndDate}`;
            const caveUrl = `https://api.thingspeak.com/channels/2865124/fields/1.json?api_key=${apiKey}&start=${formattedStartDate}&end=${formattedEndDate}`;
            
            try {
                const garageResponse = await fetch(garageUrl);
                const caveResponse = await fetch(caveUrl);
                
                if (!garageResponse.ok || !caveResponse.ok) {
                    throw new Error("Erreur lors de la récupération des données");
                }
                
                const garageData = await garageResponse.json();
                const caveData = await caveResponse.json();
                
                const formattedGarageData = formatData(garageData.feeds);
                const formattedCaveData = formatData(caveData.feeds);
                
                plotChart(formattedGarageData, formattedCaveData);
            } catch (error) {
                console.error("Erreur API:", error);
            }
        }

        function formatData(feeds) {
            if (!feeds) return [];
            return feeds.map(feed => ({
                x: new Date(feed.created_at),
                y: parseFloat(feed.field1)
            })).filter(data => !isNaN(data.y));
        }

        function movingAverage(data, windowSize) {
            let result = [];
            for (let i = 0; i < data.length; i++) {
                let start = Math.max(0, i - windowSize + 1);
                let subset = data.slice(start, i + 1);
                let avg = subset.reduce((sum, point) => sum + point.y, 0) / subset.length;
                result.push({ x: data[i].x, y: avg });
            }
            return result;
        }

        function plotChart(garageData, caveData) {
            const ctx = document.getElementById('tempChart').getContext('2d');
            if (tempChart) tempChart.destroy();
            
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Garage',
                            data: garageData,
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            borderWidth: 1,
                            pointRadius: 2,
                            pointHoverRadius: 4,
                            fill: false
                        },
                        {
                            label: 'Cave',
                            data: caveData,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            borderWidth: 1,
                            pointRadius: 2,
                            pointHoverRadius: 4,
                            fill: false
                        },
                        {
                            label: 'Garage (Moyenne mobile)',
                            data: movingAverage(garageData, 5),
                            borderColor: 'darkred',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'Cave (Moyenne mobile)',
                            data: movingAverage(caveData, 5),
                            borderColor: 'darkblue',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                tooltipFormat: 'YYYY-MM-DD HH:mm'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Température (°C)'
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
