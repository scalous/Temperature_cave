<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Évolution de la Température</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #chartContainer {
            width: 100%;
            height: 80%;
            position: relative;
        }
        #tempChart {
            width: 100%;
            height: 100%;
        }
        #scaleControls {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>
<body>
    <h2>Évolution de la Température</h2>
    <label for="start-date">Date de début :</label>
    <input type="date" id="start-date">
    <label for="end-date">Date de fin :</label>
    <input type="date" id="end-date">
    <button onclick="fetchData()">Afficher</button>

    <div id="chartContainer">
        <div id="scaleControls">
            <button onclick="changeXScale('hour')">Échelle X (Heure)</button>
            <button onclick="changeXScale('day')">Échelle X (Jour)</button>
            <button onclick="changeYScale(10)">Échelle Y (+10)</button>
            <button onclick="changeYScale(-10)">Échelle Y (-10)</button>
            <button onclick="autoScaleY()">Auto-échelle Y</button>
        </div>
        <canvas id="tempChart"></canvas>
    </div>

    <script>
        let tempChart = null;
        let yScaleMin = null;
        let yScaleMax = null;

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toISOString().slice(0, 19).replace("T", " ") + " UTC";
        }

        async function fetchData() {
            try {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                if (!startDate || !endDate) {
                    console.error("Veuillez sélectionner des dates valides.");
                    return;
                }

                const apiKeyGarage = "SPJ6Y2W1B009JQTG";
                const apiKeyCave = "0UCS0BOBZ6SXGARL";

                const formattedStartDate = formatDate(startDate);
                const formattedEndDate = formatDate(endDate);
                console.log("Formatted Start Date:", formattedStartDate);
                console.log("Formatted End Date:", formattedEndDate);

                const garageUrl = `https://api.thingspeak.com/channels/2851323/fields/1.json?api_key=<span class="math-inline">\{apiKeyGarage\}&start\=</span>{formattedStartDate}&end=${formattedEndDate}`;
                const caveUrl = `https://api.thingspeak.com/channels/2865124/fields/1.json?api_key=<span class="math-inline">\{apiKeyCave\}&start\=</span>{formattedStartDate}&end=${formattedEndDate}`;

                console.log("Garage URL:", garageUrl);
                console.log("Cave URL:", caveUrl);

                const [garageResponse, caveResponse] = await Promise.all([
                    fetch(garageUrl),
                    fetch(caveUrl)
                ]);

                if (!garageResponse.ok) {
                    const errorData = await garageResponse.text();
                    throw new Error(`Garage API Error: ${garageResponse.statusText}, Response: ${errorData}`);
                }
                if (!caveResponse.ok) {
                    const errorData = await caveResponse.text();
                    throw new Error(`Cave API Error: ${caveResponse.statusText}, Response: ${errorData}`);
                }

                const garageData = await garageResponse.json();
                const caveData = await caveResponse.json();

                if (!garageData.feeds || !caveData.feeds) {
                    throw new Error("Les données sont absentes ou mal formatées.");
                }

                const formattedGarageData = formatData(garageData.feeds);
                const formattedCaveData = formatData(caveData.feeds);

                plotChart(formattedGarageData, formattedCaveData);
            } catch (error) {
                console.error("Erreur API:", error);
            }
        }

        function formatData(feeds) {
            return feeds.map(feed => ({
                x: new Date(feed.created_at),
                y: parseFloat(feed.field1)
            })).filter(data => !isNaN(data.y));
        }

        function movingAverage(data, windowSize) {
            let result = [];
            for (let i = 0; i < data.length; i++) {
                let start = Math.max(0, i - windowSize + 1);
                let subset = data.slice(start, i + 1);
                let avg = subset.reduce((sum, point) => sum + point.y, 0) / subset.length;
                result.push({ x: data[i].x, y: avg });
            }
            return result;
        }

        function plotChart(garageData, caveData) {
            const ctx = document.getElementById('tempChart').getContext('2d');
            if (tempChart) {
                tempChart.destroy();
            }

            const allData = garageData.concat(caveData);
            const temperatures = allData.map(data => data.y);
            const minTemp = Math.min(...temperatures);
            const maxTemp = Math.max(...temperatures);

            if (yScaleMin === null) yScaleMin = minTemp - 2;
            if (yScaleMax === null) yScaleMax = maxTemp + 2;

            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Garage',
                            data: garageData,
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            borderWidth: 1,
                            pointRadius: 2,
                            pointHoverRadius: 4,
                            fill: false
                        },
                        {
                            label: 'Cave',
                            data: caveData,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            borderWidth: 1,
                            pointRadius: 2,
                            pointHoverRadius: 4,
                            fill: false
                        },
                        {
                            label: 'Garage (Moyenne mobile)',
                            data: movingAverage(garageData, 5),
                            borderColor: 'darkred',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'Cave (Moyenne mobile)',
                            data: movingAverage(caveData, 5),
                            borderColor: 'darkblue',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                tooltipFormat: 'YYYY-MM-DD HH:mm'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            min: yScaleMin,
                            max: yScaleMax,
                            title: {
                                display: true,
                                text: 'Température (°C)'
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x'
                            }
                        }
                    }
                }
            });
        }
