<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Évolution de la Température</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #chartContainer {
            width: 100%;
            height: 80%;
            position: relative;
        }
        #tempChart {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <h2>Évolution de la Température</h2>
    <label for="start-date">Date de début :</label>
    <input type="date" id="start-date">
    <label for="end-date">Date de fin :</label>
    <input type="date" id="end-date">
    <button id="fetchButton">Afficher</button>
    <button id="autoScaleButton">Auto-échelle Y</button>

    <div id="chartContainer">
        <canvas id="tempChart"></canvas>
    </div>

    <script>
        console.log("Script chargé");

        let tempChart = null;
        let yScaleMin = null;
        let yScaleMax = null;

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toISOString().slice(0, 19).replace("T", " ") + " UTC";
        }

        async function fetchData() {
            console.log("fetchData() appelé");
            try {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                if (!startDate || !endDate) {
                    console.error("Veuillez sélectionner des dates valides.");
                    return;
                }

                const apiKeyGarage = "SPJ6Y2W1B009JQTG";
                const apiKeyCave = "0UCS0BOBZ6SXGARL";

                const formattedStartDate = formatDate(startDate);
                const formattedEndDate = formatDate(endDate);

                const garageUrl = `https://api.thingspeak.com/channels/2851323/fields/1.json?api_key=${apiKeyGarage}&start=${formattedStartDate}&end=${formattedEndDate}`;
                const caveUrl = `https://api.thingspeak.com/channels/2865124/fields/1.json?api_key=${apiKeyCave}&start=${formattedStartDate}&end=${formattedEndDate}`;
                const exterieurUrl = "https://api.thingspeak.com/channels/2875447/fields/1.json?api_key=2UWYLM7YZ3VLYW8J&results=100";

                const [garageResponse, caveResponse, exterieurResponse] = await Promise.all([
                    fetch(garageUrl),
                    fetch(caveUrl),
                    fetch(exterieurUrl)
                ]);

                if (!garageResponse.ok || !caveResponse.ok || !exterieurResponse.ok) {
                    throw new Error("Erreur lors de la récupération des données.");
                }

                const garageData = await garageResponse.json();
                const caveData = await caveResponse.json();
                const exterieurData = await exterieurResponse.json();

                if (!garageData.feeds || !caveData.feeds || !exterieurData.feeds) {
                    throw new Error("Données absentes ou mal formatées.");
                }

                const formattedGarageData = formatData(garageData.feeds);
                const formattedCaveData = formatData(caveData.feeds);
                const formattedExterieurData = formatData(exterieurData.feeds);

                plotChart(formattedGarageData, formattedCaveData, formattedExterieurData);
            } catch (error) {
                console.error("Erreur API:", error);
            }
        }

        function formatData(feeds) {
            return feeds.map(feed => ({
                x: new Date(feed.created_at),
                y: parseFloat(feed.field1)
            })).filter(data => !isNaN(data.y));
        }

        function movingAverage(data, windowSize) {
            return data.map((point, i) => {
                let start = Math.max(0, i - windowSize + 1);
                let subset = data.slice(start, i + 1);
                let avg = subset.reduce((sum, p) => sum + p.y, 0) / subset.length;
                return { x: point.x, y: avg };
            });
        }

        function plotChart(garageData, caveData, exterieurData) {
            const ctx = document.getElementById('tempChart').getContext('2d');
            if (tempChart) tempChart.destroy();

            const allData = garageData.concat(caveData, exterieurData);
            const temperatures = allData.map(data => data.y);
            const minTemp = Math.min(...temperatures);
            const maxTemp = Math.max(...temperatures);

            if (yScaleMin === null) yScaleMin = minTemp - 2;
            if (yScaleMax === null) yScaleMax = maxTemp + 2;

            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Garage',
                            data: garageData,
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.1)',
                            borderWidth: 1,
                            pointRadius: 2
                        },
                        {
                            label: 'Cave',
                            data: caveData,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            borderWidth: 1,
                            pointRadius: 2
                        },
                        {
                            label: 'Extérieur',
                            data: exterieurData,
                            borderColor: 'green',
                            backgroundColor: 'rgba(0, 255, 0, 0.1)',
                            borderWidth: 1,
                            pointRadius: 2
                        },
                        {
                            label: 'Garage (Moyenne mobile)',
                            data: movingAverage(garageData, 5),
                            borderColor: 'darkred',
                            borderWidth: 2,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Cave (Moyenne mobile)',
                            data: movingAverage(caveData, 5),
                            borderColor: 'darkblue',
                            borderWidth: 2,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Extérieur (Moyenne mobile)',
                            data: movingAverage(exterieurData, 5),
                            borderColor: 'darkgreen',
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                tooltipFormat: 'yyyy-MM-dd HH:mm',
                                displayFormats: {
                                    hour: 'dd MMM HH:mm'
                                }
                            }
                        },
                        y: {
                            min: yScaleMin,
                            max: yScaleMax,
                            title: {
                                display: true,
                                text: 'Température (°C)'
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: { enabled: true, mode: 'xy' },
                            zoom: { enabled: true, mode: 'xy' }
                        }
                    }
                }
            });
        }

        function autoScaleY() {
            yScaleMin = null;
            yScaleMax = null;
            fetchData();
        }

        document.getElementById('fetchButton').addEventListener('click', fetchData);
        document.getElementById('autoScaleButton').addEventListener('click', autoScaleY);
    </script>
</body>
</html>
